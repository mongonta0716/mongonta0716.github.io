<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>M5GFX API Documents: lgfx_qrcode.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">M5GFX API Documents
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="../../dir_4a8796b0ba1d3dc122873832137fbe4e.html">GitRepos</a></li><li class="navelem"><a class="el" href="../../dir_8a5de00820bae29ce67e663e304fc697.html">M5GFX</a></li><li class="navelem"><a class="el" href="../../dir_330f8932d6149eb3f4f70831739d3193.html">src</a></li><li class="navelem"><a class="el" href="../../dir_9d027546c025e9fadc122f32118f5ab6.html">lgfx</a></li><li class="navelem"><a class="el" href="../../dir_20b27aa10f5ef0a1b155d29039bf6c20.html">utility</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">lgfx_qrcode.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../d9/d0e/lgfx__qrcode_8c.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160; </div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d7/db8/lgfx__qrcode_8h.html">lgfx_qrcode.h</a>&quot;</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160; </div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160; </div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="preprocessor">#if __has_include(&lt;alloca.h&gt;)</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="preprocessor">#include &lt;alloca.h&gt;</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="preprocessor">#elif !defined(alloca)</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="preprocessor">#include &lt;malloc.h&gt;</span></div>
<div class="line"><a name="l00047"></a><span class="lineno"><a class="line" href="../../d9/d0e/lgfx__qrcode_8c.html#a467fdb207fabdbb103dbc08d3f5ca58e">   47</a></span>&#160;<span class="preprocessor">#define alloca _alloca</span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160; </div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="preprocessor">#ifdef max</span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="preprocessor">#undef max</span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160; </div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="comment">//#pragma mark - Error Correction Lookup tables</span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160; </div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="preprocessor">#if LOCK_VERSION == 0</span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160; </div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> uint16_t NUM_ERROR_CORRECTION_CODEWORDS[4][40] = {</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    <span class="comment">// 1,  2,  3,  4,  5,   6,   7,   8,   9,  10,  11,  12,  13,  14,  15,  16,  17,  18,  19,  20,  21,  22,  23,  24,   25,   26,   27,   28,   29,   30,   31,   32,   33,   34,   35,   36,   37,   38,   39,   40    Error correction level</span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    { 10, 16, 26, 36, 48,  64,  72,  88, 110, 130, 150, 176, 198, 216, 240, 280, 308, 338, 364, 416, 442, 476, 504, 560,  588,  644,  700,  728,  784,  812,  868,  924,  980, 1036, 1064, 1120, 1204, 1260, 1316, 1372},  <span class="comment">// Medium</span></div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;    {  7, 10, 15, 20, 26,  36,  40,  48,  60,  72,  80,  96, 104, 120, 132, 144, 168, 180, 196, 224, 224, 252, 270, 300,  312,  336,  360,  390,  420,  450,  480,  510,  540,  570,  570,  600,  630,  660,  720,  750},  <span class="comment">// Low</span></div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    { 17, 28, 44, 64, 88, 112, 130, 156, 192, 224, 264, 308, 352, 384, 432, 480, 532, 588, 650, 700, 750, 816, 900, 960, 1050, 1110, 1200, 1260, 1350, 1440, 1530, 1620, 1710, 1800, 1890, 1980, 2100, 2220, 2310, 2430},  <span class="comment">// High</span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;    { 13, 22, 36, 52, 72,  96, 108, 132, 160, 192, 224, 260, 288, 320, 360, 408, 448, 504, 546, 600, 644, 690, 750, 810,  870,  952, 1020, 1050, 1140, 1200, 1290, 1350, 1440, 1530, 1590, 1680, 1770, 1860, 1950, 2040},  <span class="comment">// Quartile</span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;};</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160; </div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> uint8_t NUM_ERROR_CORRECTION_BLOCKS[4][40] = {</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    <span class="comment">// Version: (note that index 0 is for padding, and is set to an illegal value)</span></div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    <span class="comment">// 1, 2, 3, 4, 5, 6, 7, 8, 9,10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40    Error correction level</span></div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;    {  1, 1, 1, 2, 2, 4, 4, 4, 5, 5,  5,  8,  9,  9, 10, 10, 11, 13, 14, 16, 17, 17, 18, 20, 21, 23, 25, 26, 28, 29, 31, 33, 35, 37, 38, 40, 43, 45, 47, 49},  <span class="comment">// Medium</span></div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    {  1, 1, 1, 1, 1, 2, 2, 2, 2, 4,  4,  4,  4,  4,  6,  6,  6,  6,  7,  8,  8,  9,  9, 10, 12, 12, 12, 13, 14, 15, 16, 17, 18, 19, 19, 20, 21, 22, 24, 25},  <span class="comment">// Low</span></div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;    {  1, 1, 2, 4, 4, 4, 5, 6, 8, 8, 11, 11, 16, 16, 18, 16, 19, 21, 25, 25, 25, 34, 30, 32, 35, 37, 40, 42, 45, 48, 51, 54, 57, 60, 63, 66, 70, 74, 77, 81},  <span class="comment">// High</span></div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;    {  1, 1, 2, 2, 4, 4, 6, 6, 8, 8,  8, 10, 12, 16, 12, 17, 16, 18, 21, 20, 23, 23, 25, 27, 29, 34, 34, 35, 38, 40, 43, 45, 48, 51, 53, 56, 59, 62, 65, 68},  <span class="comment">// Quartile</span></div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;};</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160; </div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> uint16_t NUM_RAW_DATA_MODULES[40] = {</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;    <span class="comment">//  1,   2,   3,   4,    5,    6,    7,    8,    9,   10,   11,   12,   13,   14,   15,   16,   17,</span></div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;      208, 359, 567, 807, 1079, 1383, 1568, 1936, 2336, 2768, 3232, 3728, 4256, 4651, 5243, 5867, 6523,</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    <span class="comment">//   18,   19,   20,   21,    22,    23,    24,    25,   26,    27,     28,    29,    30,    31,</span></div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;       7211, 7931, 8683, 9252, 10068, 10916, 11796, 12708, 13652, 14628, 15371, 16411, 17483, 18587,</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;    <span class="comment">//    32,    33,    34,    35,    36,    37,    38,    39,    40</span></div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;       19723, 20891, 22091, 23008, 24272, 25568, 26896, 28256, 29648</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;};</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160; </div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;<span class="comment">// @TODO: Put other LOCK_VERSIONS here</span></div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;<span class="preprocessor">#elif LOCK_VERSION == 3</span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160; </div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> int16_t NUM_ERROR_CORRECTION_CODEWORDS[4] = {</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    26, 15, 44, 36</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;};</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160; </div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> int8_t NUM_ERROR_CORRECTION_BLOCKS[4] = {</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    1, 1, 2, 2</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;};</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160; </div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> uint16_t NUM_RAW_DATA_MODULES = 567;</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160; </div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160; </div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;<span class="preprocessor">#error Unsupported LOCK_VERSION (add it...)</span></div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160; </div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160; </div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160; </div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> max(<span class="keywordtype">int</span> a, <span class="keywordtype">int</span> b) {</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    <span class="keywordflow">return</span> (a &gt; b) ? a : b;</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;}</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160; </div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;<span class="comment">static int abs(int value) {</span></div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;<span class="comment">    if (value &lt; 0) { return -value; }</span></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;<span class="comment">    return value;</span></div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;<span class="comment">}</span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160; </div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160; </div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;<span class="comment">//#pragma mark - Mode testing and conversion</span></div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160; </div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;<span class="keyword">static</span> int8_t getAlphanumeric(<span class="keywordtype">char</span> c) {</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160; </div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    <span class="keywordflow">if</span> (c &gt;= <span class="charliteral">&#39;0&#39;</span> &amp;&amp; c &lt;= <span class="charliteral">&#39;9&#39;</span>) { <span class="keywordflow">return</span> (c - <span class="charliteral">&#39;0&#39;</span>); }</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    <span class="keywordflow">if</span> (c &gt;= <span class="charliteral">&#39;A&#39;</span> &amp;&amp; c &lt;= <span class="charliteral">&#39;Z&#39;</span>) { <span class="keywordflow">return</span> (c - <span class="charliteral">&#39;A&#39;</span> + 10); }</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160; </div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    <span class="keywordflow">switch</span> (c) {</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;        <span class="keywordflow">case</span> <span class="charliteral">&#39; &#39;</span>: <span class="keywordflow">return</span> 36;</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;        <span class="keywordflow">case</span> <span class="charliteral">&#39;$&#39;</span>: <span class="keywordflow">return</span> 37;</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;        <span class="keywordflow">case</span> <span class="charliteral">&#39;%&#39;</span>: <span class="keywordflow">return</span> 38;</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;        <span class="keywordflow">case</span> <span class="charliteral">&#39;*&#39;</span>: <span class="keywordflow">return</span> 39;</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;        <span class="keywordflow">case</span> <span class="charliteral">&#39;+&#39;</span>: <span class="keywordflow">return</span> 40;</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;        <span class="keywordflow">case</span> <span class="charliteral">&#39;-&#39;</span>: <span class="keywordflow">return</span> 41;</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;        <span class="keywordflow">case</span> <span class="charliteral">&#39;.&#39;</span>: <span class="keywordflow">return</span> 42;</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;        <span class="keywordflow">case</span> <span class="charliteral">&#39;/&#39;</span>: <span class="keywordflow">return</span> 43;</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;        <span class="keywordflow">case</span> <span class="charliteral">&#39;:&#39;</span>: <span class="keywordflow">return</span> 44;</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;    }</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160; </div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;    <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;}</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160; </div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;<span class="keyword">static</span> <span class="keywordtype">bool</span> isAlphanumeric(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a53eab509ea9728ec7f963272498f17e1">text</a>, uint16_t length) {</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;    <span class="keywordflow">while</span> (length != 0) {</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;        <span class="keywordflow">if</span> (getAlphanumeric(<a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a53eab509ea9728ec7f963272498f17e1">text</a>[--length]) == -1) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;    }</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;}</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160; </div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160; </div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;<span class="keyword">static</span> <span class="keywordtype">bool</span> isNumeric(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a53eab509ea9728ec7f963272498f17e1">text</a>, uint16_t length) {</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    <span class="keywordflow">while</span> (length != 0) {</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;        <span class="keywordtype">char</span> c = <a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a53eab509ea9728ec7f963272498f17e1">text</a>[--length];</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;        <span class="keywordflow">if</span> (c &lt; &#39;0&#39; || c &gt; <span class="charliteral">&#39;9&#39;</span>) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    }</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;}</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160; </div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160; </div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;<span class="comment">//#pragma mark - Counting</span></div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160; </div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;<span class="comment">// We store the following tightly packed (less 8) in modeInfo</span></div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;<span class="comment">//               &lt;=9  &lt;=26  &lt;= 40</span></div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;<span class="comment">// NUMERIC      ( 10,   12,    14);</span></div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;<span class="comment">// ALPHANUMERIC (  9,   11,    13);</span></div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;<span class="comment">// BYTE         (  8,   16,    16);</span></div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> getModeBits(uint8_t version, uint8_t mode) {</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;    <span class="comment">// Note: We use 15 instead of 16; since 15 doesn&#39;t exist and we cannot store 16 (8 + 8) in 3 bits</span></div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;    <span class="comment">// hex(int(&quot;&quot;.join(reversed([(&#39;00&#39; + bin(x - 8)[2:])[-3:] for x in [10, 9, 8, 12, 11, 15, 14, 13, 15]])), 2))</span></div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> modeInfo = 0x7bbb80a;</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160; </div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;<span class="preprocessor">#if LOCK_VERSION == 0 || LOCK_VERSION &gt; 9</span></div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;    <span class="keywordflow">if</span> (version &gt; 9) { modeInfo &gt;&gt;= 9; }</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160; </div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;<span class="preprocessor">#if LOCK_VERSION == 0 || LOCK_VERSION &gt; 26</span></div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    <span class="keywordflow">if</span> (version &gt; 26) { modeInfo &gt;&gt;= 9; }</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160; </div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    <span class="keywordtype">char</span> result = 8 + ((modeInfo &gt;&gt; (3 * mode)) &amp; 0x07);</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    <span class="keywordflow">if</span> (result == 15) { result = 16; }</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160; </div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    <span class="keywordflow">return</span> result;</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;}</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160; </div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160; </div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;<span class="comment">//#pragma mark - BitBucket</span></div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160; </div>
<div class="line"><a name="l00184"></a><span class="lineno"><a class="line" href="../../dc/d5c/structBitBucket.html">  184</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../dc/d5c/structBitBucket.html">BitBucket</a> {</div>
<div class="line"><a name="l00185"></a><span class="lineno"><a class="line" href="../../dc/d5c/structBitBucket.html#aa82a95c2871e9cd6dbdf51dc0e3e87c7">  185</a></span>&#160;    uint32_t <a class="code" href="../../dc/d5c/structBitBucket.html#aa82a95c2871e9cd6dbdf51dc0e3e87c7">bitOffsetOrWidth</a>;</div>
<div class="line"><a name="l00186"></a><span class="lineno"><a class="line" href="../../dc/d5c/structBitBucket.html#a6dc7c1877c2c661d182ef086c45dd367">  186</a></span>&#160;    uint16_t <a class="code" href="../../dc/d5c/structBitBucket.html#a6dc7c1877c2c661d182ef086c45dd367">capacityBytes</a>;</div>
<div class="line"><a name="l00187"></a><span class="lineno"><a class="line" href="../../dc/d5c/structBitBucket.html#ad7d556811266f5dfc395fbf25bd75206">  187</a></span>&#160;    uint8_t *<a class="code" href="../../dc/d5c/structBitBucket.html#ad7d556811266f5dfc395fbf25bd75206">data</a>;</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;} <a class="code" href="../../d9/d0e/lgfx__qrcode_8c.html#a3d6cd6f5c323535575f53fbff6b5c86f">BitBucket</a>;</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160; </div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;<span class="comment">void bb_dump(BitBucket *bitBuffer) {</span></div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;<span class="comment">    printf(&quot;Buffer: &quot;);</span></div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;<span class="comment">    for (uint32_t i = 0; i &lt; bitBuffer-&gt;capacityBytes; i++) {</span></div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;<span class="comment">        printf(&quot;%02x&quot;, bitBuffer-&gt;data[i]);</span></div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;<span class="comment">        if ((i % 4) == 3) { printf(&quot; &quot;); }</span></div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;<span class="comment">    }</span></div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;<span class="comment">    printf(&quot;\n&quot;);</span></div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;<span class="comment">}</span></div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160; </div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;<span class="keyword">static</span> uint16_t bb_getGridSizeBytes(uint8_t size) {</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    <span class="keywordflow">return</span> (((size * size) + 7) &gt;&gt; 3);</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;}</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160; </div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;<span class="keyword">static</span> uint16_t bb_getBufferSizeBytes(uint32_t bits) {</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;    <span class="keywordflow">return</span> ((bits + 7) &gt;&gt; 3);</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;}</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160; </div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> bb_initBuffer(<a class="code" href="../../dc/d5c/structBitBucket.html">BitBucket</a> *bitBuffer, uint8_t *<a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a>, int32_t capacityBytes) {</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    bitBuffer-&gt;<a class="code" href="../../dc/d5c/structBitBucket.html#aa82a95c2871e9cd6dbdf51dc0e3e87c7">bitOffsetOrWidth</a> = 0;</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    bitBuffer-&gt;<a class="code" href="../../dc/d5c/structBitBucket.html#a6dc7c1877c2c661d182ef086c45dd367">capacityBytes</a> = capacityBytes;</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    bitBuffer-&gt;<a class="code" href="../../dc/d5c/structBitBucket.html#ad7d556811266f5dfc395fbf25bd75206">data</a> = <a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a>;</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160; </div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;    memset(<a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a>, 0, bitBuffer-&gt;<a class="code" href="../../dc/d5c/structBitBucket.html#a6dc7c1877c2c661d182ef086c45dd367">capacityBytes</a>);</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;}</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160; </div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> bb_initGrid(<a class="code" href="../../dc/d5c/structBitBucket.html">BitBucket</a> *bitGrid, uint8_t *<a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a>, uint8_t size) {</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    bitGrid-&gt;<a class="code" href="../../dc/d5c/structBitBucket.html#aa82a95c2871e9cd6dbdf51dc0e3e87c7">bitOffsetOrWidth</a> = size;</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;    bitGrid-&gt;<a class="code" href="../../dc/d5c/structBitBucket.html#a6dc7c1877c2c661d182ef086c45dd367">capacityBytes</a> = bb_getGridSizeBytes(size);</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;    bitGrid-&gt;<a class="code" href="../../dc/d5c/structBitBucket.html#ad7d556811266f5dfc395fbf25bd75206">data</a> = <a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a>;</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160; </div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    memset(<a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a>, 0, bitGrid-&gt;<a class="code" href="../../dc/d5c/structBitBucket.html#a6dc7c1877c2c661d182ef086c45dd367">capacityBytes</a>);</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;}</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160; </div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;<span class="keyword">static</span> <span class="keywordtype">bool</span> bb_appendBits(<a class="code" href="../../dc/d5c/structBitBucket.html">BitBucket</a> *bitBuffer, uint32_t val, uint8_t length) {</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    uint32_t offset = bitBuffer-&gt;<a class="code" href="../../dc/d5c/structBitBucket.html#aa82a95c2871e9cd6dbdf51dc0e3e87c7">bitOffsetOrWidth</a>;</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    <span class="keywordflow">for</span> (int_fast8_t i = length - 1; i &gt;= 0; i--, offset++) {</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;        <span class="keywordtype">size_t</span> index = offset &gt;&gt; 3;</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;        <span class="keywordflow">if</span> (bitBuffer-&gt;<a class="code" href="../../dc/d5c/structBitBucket.html#a6dc7c1877c2c661d182ef086c45dd367">capacityBytes</a> &lt;= index) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;        bitBuffer-&gt;<a class="code" href="../../dc/d5c/structBitBucket.html#ad7d556811266f5dfc395fbf25bd75206">data</a>[index] |= ((val &gt;&gt; i) &amp; 1) &lt;&lt; (7 - (offset &amp; 7));</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;    }</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;    bitBuffer-&gt;<a class="code" href="../../dc/d5c/structBitBucket.html#aa82a95c2871e9cd6dbdf51dc0e3e87c7">bitOffsetOrWidth</a> = offset;</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;}</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;<span class="comment">void bb_setBits(BitBucket *bitBuffer, uint32_t val, int offset, uint8_t length) {</span></div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;<span class="comment">    for (int8_t i = length - 1; i &gt;= 0; i--, offset++) {</span></div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;<span class="comment">        bitBuffer-&gt;data[offset &gt;&gt; 3] |= ((val &gt;&gt; i) &amp; 1) &lt;&lt; (7 - (offset &amp; 7));</span></div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;<span class="comment">    }</span></div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;<span class="comment">}</span></div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> bb_setBit(<a class="code" href="../../dc/d5c/structBitBucket.html">BitBucket</a> *bitGrid, uint_fast8_t x, uint_fast8_t y, <span class="keywordtype">bool</span> on) {</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;    uint32_t offset = y * bitGrid-&gt;<a class="code" href="../../dc/d5c/structBitBucket.html#aa82a95c2871e9cd6dbdf51dc0e3e87c7">bitOffsetOrWidth</a> + x;</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;    uint8_t mask = 1 &lt;&lt; (7 - (offset &amp; 0x07));</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;    <span class="keywordflow">if</span> (on) {</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;        bitGrid-&gt;<a class="code" href="../../dc/d5c/structBitBucket.html#ad7d556811266f5dfc395fbf25bd75206">data</a>[offset &gt;&gt; 3] |= mask;</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;        bitGrid-&gt;<a class="code" href="../../dc/d5c/structBitBucket.html#ad7d556811266f5dfc395fbf25bd75206">data</a>[offset &gt;&gt; 3] &amp;= ~mask;</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    }</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;}</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160; </div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> bb_invertBit(<a class="code" href="../../dc/d5c/structBitBucket.html">BitBucket</a> *bitGrid, uint_fast8_t x, uint_fast8_t y, <span class="keywordtype">bool</span> invert) {</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;    uint32_t offset = y * bitGrid-&gt;<a class="code" href="../../dc/d5c/structBitBucket.html#aa82a95c2871e9cd6dbdf51dc0e3e87c7">bitOffsetOrWidth</a> + x;</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;    uint8_t mask = 1 &lt;&lt; (7 - (offset &amp; 0x07));</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;    <span class="keywordtype">bool</span> on = ((bitGrid-&gt;<a class="code" href="../../dc/d5c/structBitBucket.html#ad7d556811266f5dfc395fbf25bd75206">data</a>[offset &gt;&gt; 3] &amp; (1 &lt;&lt; (7 - (offset &amp; 0x07)))) != 0);</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;    <span class="keywordflow">if</span> (on ^ invert) {</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;        bitGrid-&gt;<a class="code" href="../../dc/d5c/structBitBucket.html#ad7d556811266f5dfc395fbf25bd75206">data</a>[offset &gt;&gt; 3] |= mask;</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;        bitGrid-&gt;<a class="code" href="../../dc/d5c/structBitBucket.html#ad7d556811266f5dfc395fbf25bd75206">data</a>[offset &gt;&gt; 3] &amp;= ~mask;</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;    }</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;}</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160; </div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;<span class="keyword">static</span> <span class="keywordtype">bool</span> bb_getBit(<a class="code" href="../../dc/d5c/structBitBucket.html">BitBucket</a> *bitGrid, uint_fast8_t x, uint_fast8_t y) {</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;    uint32_t offset = y * bitGrid-&gt;<a class="code" href="../../dc/d5c/structBitBucket.html#aa82a95c2871e9cd6dbdf51dc0e3e87c7">bitOffsetOrWidth</a> + x;</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;    <span class="keywordflow">return</span> (bitGrid-&gt;<a class="code" href="../../dc/d5c/structBitBucket.html#ad7d556811266f5dfc395fbf25bd75206">data</a>[offset &gt;&gt; 3] &amp; (1 &lt;&lt; (7 - (offset &amp; 0x07)))) != 0;</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;}</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160; </div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160; </div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;<span class="comment">//#pragma mark - Drawing Patterns</span></div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160; </div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;<span class="comment">// XORs the data modules in this QR Code with the given mask pattern. Due to XOR&#39;s mathematical</span></div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;<span class="comment">// properties, calling applyMask(m) twice with the same value is equivalent to no change at all.</span></div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;<span class="comment">// This means it is possible to apply a mask, undo it, and try another mask. Note that a final</span></div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;<span class="comment">// well-formed QR Code symbol needs exactly one mask applied (not zero, not two, etc.).</span></div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> applyMask(<a class="code" href="../../dc/d5c/structBitBucket.html">BitBucket</a> *modules, <a class="code" href="../../dc/d5c/structBitBucket.html">BitBucket</a> *isFunction, uint8_t mask) {</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;    uint8_t size = modules-&gt;<a class="code" href="../../dc/d5c/structBitBucket.html#aa82a95c2871e9cd6dbdf51dc0e3e87c7">bitOffsetOrWidth</a>;</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160; </div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;    <span class="keywordflow">for</span> (uint_fast8_t y = 0; y &lt; size; y++) {</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;        <span class="keywordflow">for</span> (uint_fast8_t x = 0; x &lt; size; x++) {</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;            <span class="keywordflow">if</span> (bb_getBit(isFunction, x, y)) { <span class="keywordflow">continue</span>; }</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160; </div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;            <span class="keywordtype">bool</span> invert = 0;</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;            <span class="keywordflow">switch</span> (mask) {</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;                <span class="keywordflow">case</span> 0:  invert = ((x + y) &amp; 1) == 0;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;                <span class="keywordflow">case</span> 1:  invert = (y &amp; 1) == 0;                          <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;                <span class="keywordflow">case</span> 2:  invert = (x % 3) == 0;                          <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;                <span class="keywordflow">case</span> 3:  invert = ((x + y) % 3) == 0;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;                <span class="keywordflow">case</span> 4:  invert = ((x / 3 + (y &gt;&gt; 1)) &amp; 1) == 0;         <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;                <span class="keywordflow">case</span> 5:  invert = (((x * y) &amp; 1) + x * y % 3) == 0;      <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;                <span class="keywordflow">case</span> 6:  invert = ((((x * y) &amp; 1) + x * y % 3) &amp; 1) == 0;<span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;                <span class="keywordflow">case</span> 7:  invert = ((((x + y) &amp; 1) + x * y % 3) &amp; 1) == 0;<span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;            }</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;            bb_invertBit(modules, x, y, invert);</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;        }</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;    }</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;}</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160; </div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> setFunctionModule(<a class="code" href="../../dc/d5c/structBitBucket.html">BitBucket</a> *modules, <a class="code" href="../../dc/d5c/structBitBucket.html">BitBucket</a> *isFunction, uint_fast8_t x, uint_fast8_t y, <span class="keywordtype">bool</span> on) {</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;    bb_setBit(modules, x, y, on);</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;    bb_setBit(isFunction, x, y, <span class="keyword">true</span>);</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;}</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160; </div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;<span class="comment">// Draws a 9*9 finder pattern including the border separator, with the center module at (x, y).</span></div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> drawFinderPattern(<a class="code" href="../../dc/d5c/structBitBucket.html">BitBucket</a> *modules, <a class="code" href="../../dc/d5c/structBitBucket.html">BitBucket</a> *isFunction, uint_fast8_t x, uint_fast8_t y) {</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;    uint8_t size = modules-&gt;<a class="code" href="../../dc/d5c/structBitBucket.html#aa82a95c2871e9cd6dbdf51dc0e3e87c7">bitOffsetOrWidth</a>;</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160; </div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;    <span class="keywordflow">for</span> (int_fast8_t i = -4; i &lt;= 4; i++) {</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;        <span class="keywordflow">for</span> (int_fast8_t j = -4; j &lt;= 4; j++) {</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;            uint_fast8_t dist = max(abs(i), abs(j));  <span class="comment">// Chebyshev/infinity norm</span></div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;            int_fast16_t xx = x + j, yy = y + i;</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;            <span class="keywordflow">if</span> (0 &lt;= xx &amp;&amp; xx &lt; size &amp;&amp; 0 &lt;= yy &amp;&amp; yy &lt; size) {</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;                setFunctionModule(modules, isFunction, xx, yy, dist != 2 &amp;&amp; dist != 4);</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;            }</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;        }</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;    }</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;}</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160; </div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;<span class="comment">// Draws a 5*5 alignment pattern, with the center module at (x, y).</span></div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> drawAlignmentPattern(<a class="code" href="../../dc/d5c/structBitBucket.html">BitBucket</a> *modules, <a class="code" href="../../dc/d5c/structBitBucket.html">BitBucket</a> *isFunction, uint_fast8_t x, uint_fast8_t y) {</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;    <span class="keywordflow">for</span> (int_fast8_t i = -2; i &lt;= 2; i++) {</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;        <span class="keywordflow">for</span> (int_fast8_t j = -2; j &lt;= 2; j++) {</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;            setFunctionModule(modules, isFunction, x + j, y + i, max(abs(i), abs(j)) != 1);</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;        }</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;    }</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;}</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160; </div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;<span class="comment">// Draws two copies of the format bits (with its own error correction code)</span></div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;<span class="comment">// based on the given mask and this object&#39;s error correction level field.</span></div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> drawFormatBits(<a class="code" href="../../dc/d5c/structBitBucket.html">BitBucket</a> *modules, <a class="code" href="../../dc/d5c/structBitBucket.html">BitBucket</a> *isFunction, uint8_t ecc, uint8_t mask) {</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160; </div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;    uint8_t size = modules-&gt;<a class="code" href="../../dc/d5c/structBitBucket.html#aa82a95c2871e9cd6dbdf51dc0e3e87c7">bitOffsetOrWidth</a>;</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160; </div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;    <span class="comment">// Calculate error correction code and pack bits</span></div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;    uint32_t <a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a> = ecc &lt;&lt; 3 | mask;  <span class="comment">// errCorrLvl is uint2, mask is uint3</span></div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;    uint32_t rem = <a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a>;</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 10; i++) {</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;        rem = (rem &lt;&lt; 1) ^ ((rem &gt;&gt; 9) * 0x537);</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;    }</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160; </div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;    <a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a> = <a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a> &lt;&lt; 10 | rem;</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;    <a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a> ^= 0x5412;  <span class="comment">// uint15</span></div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160; </div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;    <span class="comment">// Draw first copy</span></div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;    <span class="keywordflow">for</span> (uint_fast8_t i = 0; i &lt;= 5; i++) {</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;        setFunctionModule(modules, isFunction, 8, i, ((<a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a> &gt;&gt; i) &amp; 1) != 0);</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;    }</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160; </div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;    setFunctionModule(modules, isFunction, 8, 7, ((<a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a> &gt;&gt; 6) &amp; 1) != 0);</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;    setFunctionModule(modules, isFunction, 8, 8, ((<a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a> &gt;&gt; 7) &amp; 1) != 0);</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;    setFunctionModule(modules, isFunction, 7, 8, ((<a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a> &gt;&gt; 8) &amp; 1) != 0);</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160; </div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;    <span class="keywordflow">for</span> (int_fast8_t i = 9; i &lt; 15; i++) {</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;        setFunctionModule(modules, isFunction, 14 - i, 8, ((<a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a> &gt;&gt; i) &amp; 1) != 0);</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;    }</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160; </div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;    <span class="comment">// Draw second copy</span></div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;    <span class="keywordflow">for</span> (int_fast8_t i = 0; i &lt;= 7; i++) {</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;        setFunctionModule(modules, isFunction, size - 1 - i, 8, ((<a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a> &gt;&gt; i) &amp; 1) != 0);</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;    }</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160; </div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;    <span class="keywordflow">for</span> (int_fast8_t i = 8; i &lt; 15; i++) {</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;        setFunctionModule(modules, isFunction, 8, size - 15 + i, ((<a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a> &gt;&gt; i) &amp; 1) != 0);</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;    }</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160; </div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;    setFunctionModule(modules, isFunction, 8, size - 8, <span class="keyword">true</span>);</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;}</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160; </div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160; </div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;<span class="comment">// Draws two copies of the version bits (with its own error correction code),</span></div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;<span class="comment">// based on this object&#39;s version field (which only has an effect for 7 &lt;= version &lt;= 40).</span></div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> drawVersion(<a class="code" href="../../dc/d5c/structBitBucket.html">BitBucket</a> *modules, <a class="code" href="../../dc/d5c/structBitBucket.html">BitBucket</a> *isFunction, uint8_t version) {</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160; </div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;    int8_t size = modules-&gt;<a class="code" href="../../dc/d5c/structBitBucket.html#aa82a95c2871e9cd6dbdf51dc0e3e87c7">bitOffsetOrWidth</a>;</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160; </div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;<span class="preprocessor">#if LOCK_VERSION != 0 &amp;&amp; LOCK_VERSION &lt; 7</span></div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160; </div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;    <span class="keywordflow">if</span> (version &lt; 7) { <span class="keywordflow">return</span>; }</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160; </div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;    <span class="comment">// Calculate error correction code and pack bits</span></div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;    uint32_t rem = version;  <span class="comment">// version is uint6, in the range [7, 40]</span></div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;    <span class="keywordflow">for</span> (uint_fast8_t i = 0; i &lt; 12; i++) {</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;        rem = (rem &lt;&lt; 1) ^ ((rem &gt;&gt; 11) * 0x1F25);</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;    }</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160; </div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;    uint32_t <a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a> = version &lt;&lt; 12 | rem;  <span class="comment">// uint18</span></div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160; </div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;    <span class="comment">// Draw two copies</span></div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;    <span class="keywordflow">for</span> (uint_fast8_t i = 0; i &lt; 18; i++) {</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;        <span class="keywordtype">bool</span> bit = ((<a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a> &gt;&gt; i) &amp; 1) != 0;</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;        uint8_t a = size - 11 + i % 3, b = i / 3;</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;        setFunctionModule(modules, isFunction, a, b, bit);</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;        setFunctionModule(modules, isFunction, b, a, bit);</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;    }</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160; </div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;}</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160; </div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> drawFunctionPatterns(<a class="code" href="../../dc/d5c/structBitBucket.html">BitBucket</a> *modules, <a class="code" href="../../dc/d5c/structBitBucket.html">BitBucket</a> *isFunction, uint8_t version, uint8_t ecc) {</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160; </div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;    uint8_t size = modules-&gt;<a class="code" href="../../dc/d5c/structBitBucket.html#aa82a95c2871e9cd6dbdf51dc0e3e87c7">bitOffsetOrWidth</a>;</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160; </div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;    <span class="comment">// Draw the horizontal and vertical timing patterns</span></div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;    <span class="keywordflow">for</span> (uint_fast8_t i = 0; i &lt; size; i++) {</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;        setFunctionModule(modules, isFunction, 6, i, (i &amp; 1) == 0);</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;        setFunctionModule(modules, isFunction, i, 6, (i &amp; 1) == 0);</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;    }</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160; </div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;    <span class="comment">// Draw 3 finder patterns (all corners except bottom right; overwrites some timing modules)</span></div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;    drawFinderPattern(modules, isFunction, 3, 3);</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;    drawFinderPattern(modules, isFunction, size - 4, 3);</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;    drawFinderPattern(modules, isFunction, 3, size - 4);</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160; </div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;<span class="preprocessor">#if LOCK_VERSION == 0 || LOCK_VERSION &gt; 1</span></div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160; </div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;    <span class="keywordflow">if</span> (version &gt; 1) {</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160; </div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;        <span class="comment">// Draw the numerous alignment patterns</span></div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160; </div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;        uint_fast8_t alignCount = version / 7 + 2;</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;        uint_fast8_t step;</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;        <span class="keywordflow">if</span> (version != 32) {</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;            step = (version * 4 + alignCount * 2 + 1) / (2 * alignCount - 2) * 2;  <span class="comment">// ceil((size - 13) / (2*numAlign - 2)) * 2</span></div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;        } <span class="keywordflow">else</span> { <span class="comment">// C-C-C-Combo breaker!</span></div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;            step = 26;</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;        }</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160; </div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;        uint_fast8_t alignPositionIndex = alignCount - 1;</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;        uint8_t* alignPosition = (uint8_t*)<a class="code" href="../../d9/d0e/lgfx__qrcode_8c.html#a467fdb207fabdbb103dbc08d3f5ca58e">alloca</a>(alignCount);</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160; </div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;        alignPosition[0] = 6;</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160; </div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;        uint8_t size_ = version * 4 + 17;</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;        <span class="keywordflow">for</span> (uint_fast8_t i = 0, pos = size_ - 7; i &lt; alignCount - 1; i++, pos -= step) {</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;            alignPosition[alignPositionIndex--] = pos;</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;        }</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160; </div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;        <span class="keywordflow">for</span> (uint_fast8_t i = 0; i &lt; alignCount; i++) {</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;            <span class="keywordflow">for</span> (uint_fast8_t j = 0; j &lt; alignCount; j++) {</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;                <span class="keywordflow">if</span> ((i == 0 &amp;&amp; j == 0) || (i == 0 &amp;&amp; j == alignCount - 1) || (i == alignCount - 1 &amp;&amp; j == 0)) {</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;                    <span class="keywordflow">continue</span>;  <span class="comment">// Skip the three finder corners</span></div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;                } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;                    drawAlignmentPattern(modules, isFunction, alignPosition[i], alignPosition[j]);</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;                }</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;            }</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;        }</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;    }</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160; </div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160; </div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;    <span class="comment">// Draw configuration data</span></div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;    drawFormatBits(modules, isFunction, ecc, 0);  <span class="comment">// Dummy mask value; overwritten later in the constructor</span></div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;    drawVersion(modules, isFunction, version);</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;}</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160; </div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160; </div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;<span class="comment">// Draws the given sequence of 8-bit codewords (data and error correction) onto the entire</span></div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;<span class="comment">// data area of this QR Code symbol. Function modules need to be marked off before this is called.</span></div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> drawCodewords(<a class="code" href="../../dc/d5c/structBitBucket.html">BitBucket</a> *modules, <a class="code" href="../../dc/d5c/structBitBucket.html">BitBucket</a> *isFunction, <a class="code" href="../../dc/d5c/structBitBucket.html">BitBucket</a> *codewords) {</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160; </div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;    uint32_t bitLength = codewords-&gt;<a class="code" href="../../dc/d5c/structBitBucket.html#aa82a95c2871e9cd6dbdf51dc0e3e87c7">bitOffsetOrWidth</a>;</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;    uint8_t *<a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a> = codewords-&gt;<a class="code" href="../../dc/d5c/structBitBucket.html#ad7d556811266f5dfc395fbf25bd75206">data</a>;</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160; </div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;    uint8_t size = modules-&gt;<a class="code" href="../../dc/d5c/structBitBucket.html#aa82a95c2871e9cd6dbdf51dc0e3e87c7">bitOffsetOrWidth</a>;</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160; </div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;    <span class="comment">// Bit index into the data</span></div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;    uint32_t i = 0;</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160; </div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;    <span class="comment">// Do the funny zigzag scan</span></div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;    <span class="keywordflow">for</span> (int_fast16_t right = size - 1; right &gt;= 1; right -= 2) {  <span class="comment">// Index of right column in each column pair</span></div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;        <span class="keywordflow">if</span> (right == 6) { right = 5; }</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160; </div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;        <span class="keywordflow">for</span> (uint_fast8_t vert = 0; vert &lt; size; vert++) {  <span class="comment">// Vertical counter</span></div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; 2; j++) {</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;                uint8_t x = right - j;  <span class="comment">// Actual x coordinate</span></div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;                <span class="keywordtype">bool</span> upwards = ((right &amp; 2) == 0) ^ (x &lt; 6);</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;                uint8_t y = upwards ? size - 1 - vert : vert;  <span class="comment">// Actual y coordinate</span></div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;                <span class="keywordflow">if</span> (!bb_getBit(isFunction, x, y) &amp;&amp; i &lt; bitLength) {</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;                    bb_setBit(modules, x, y, ((<a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a>[i &gt;&gt; 3] &gt;&gt; (7 - (i &amp; 7))) &amp; 1) != 0);</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;                    i++;</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;                }</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;                <span class="comment">// If there are any remainder bits (0 to 7), they are already</span></div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;                <span class="comment">// set to 0/false/white when the grid of modules was initialized</span></div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;            }</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;        }</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;    }</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;}</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160; </div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160; </div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160; </div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;<span class="comment">//#pragma mark - Penalty Calculation</span></div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160; </div>
<div class="line"><a name="l00494"></a><span class="lineno"><a class="line" href="../../d9/d0e/lgfx__qrcode_8c.html#a7b8f587ba0383fce5bb85edeb556e798">  494</a></span>&#160;<span class="preprocessor">#define PENALTY_N1      3</span></div>
<div class="line"><a name="l00495"></a><span class="lineno"><a class="line" href="../../d9/d0e/lgfx__qrcode_8c.html#a519b1f43f3570c5b453d00be72024cd1">  495</a></span>&#160;<span class="preprocessor">#define PENALTY_N2      3</span></div>
<div class="line"><a name="l00496"></a><span class="lineno"><a class="line" href="../../d9/d0e/lgfx__qrcode_8c.html#a0dc343ed4ac58dac0756fa31d88d40b9">  496</a></span>&#160;<span class="preprocessor">#define PENALTY_N3     40</span></div>
<div class="line"><a name="l00497"></a><span class="lineno"><a class="line" href="../../d9/d0e/lgfx__qrcode_8c.html#a376d6e3e4466769cdc71fee01c260774">  497</a></span>&#160;<span class="preprocessor">#define PENALTY_N4     10</span></div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160; </div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;<span class="comment">// Calculates and returns the penalty score based on state of this QR Code&#39;s current modules.</span></div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;<span class="comment">// This is used by the automatic mask choice algorithm to find the mask pattern that yields the lowest score.</span></div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;<span class="comment">// @TODO: This can be optimized by working with the bytes instead of bits.</span></div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;<span class="keyword">static</span> uint32_t getPenaltyScore(<a class="code" href="../../dc/d5c/structBitBucket.html">BitBucket</a> *modules) {</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;    uint32_t result = 0;</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160; </div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;    uint8_t size = modules-&gt;<a class="code" href="../../dc/d5c/structBitBucket.html#aa82a95c2871e9cd6dbdf51dc0e3e87c7">bitOffsetOrWidth</a>;</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160; </div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;    <span class="comment">// Adjacent modules in row having same color</span></div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;    <span class="keywordflow">for</span> (uint_fast8_t y = 0; y &lt; size; y++) {</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160; </div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;        <span class="keywordtype">bool</span> colorX = bb_getBit(modules, 0, y);</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;        <span class="keywordflow">for</span> (uint_fast8_t x = 1, runX = 1; x &lt; size; x++) {</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;            <span class="keywordtype">bool</span> cx = bb_getBit(modules, x, y);</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;            <span class="keywordflow">if</span> (cx != colorX) {</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;                colorX = cx;</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;                runX = 1;</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160; </div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;            } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;                runX++;</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;                <span class="keywordflow">if</span> (runX == 5) {</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;                    result += <a class="code" href="../../d9/d0e/lgfx__qrcode_8c.html#a7b8f587ba0383fce5bb85edeb556e798">PENALTY_N1</a>;</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (runX &gt; 5) {</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;                    result++;</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;                }</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;            }</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;        }</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;    }</div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160; </div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;    <span class="comment">// Adjacent modules in column having same color</span></div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;    <span class="keywordflow">for</span> (uint_fast8_t x = 0; x &lt; size; x++) {</div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;        <span class="keywordtype">bool</span> colorY = bb_getBit(modules, x, 0);</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;        <span class="keywordflow">for</span> (uint_fast8_t y = 1, runY = 1; y &lt; size; y++) {</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;            <span class="keywordtype">bool</span> cy = bb_getBit(modules, x, y);</div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;            <span class="keywordflow">if</span> (cy != colorY) {</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;                colorY = cy;</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;                runY = 1;</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;            } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;                runY++;</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;                <span class="keywordflow">if</span> (runY == 5) {</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;                    result += <a class="code" href="../../d9/d0e/lgfx__qrcode_8c.html#a7b8f587ba0383fce5bb85edeb556e798">PENALTY_N1</a>;</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (runY &gt; 5) {</div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;                    result++;</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;                }</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;            }</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;        }</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;    }</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160; </div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;    uint16_t black = 0;</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;    <span class="keywordflow">for</span> (uint_fast8_t y = 0; y &lt; size; y++) {</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;        uint_fast16_t bitsRow = 0, bitsCol = 0;</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;        <span class="keywordflow">for</span> (uint_fast8_t x = 0; x &lt; size; x++) {</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;            <span class="keywordtype">bool</span> color = bb_getBit(modules, x, y);</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160; </div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;            <span class="comment">// 2*2 blocks of modules having same color</span></div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;            <span class="keywordflow">if</span> (x &gt; 0 &amp;&amp; y &gt; 0) {</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;                <span class="keywordtype">bool</span> colorUL = bb_getBit(modules, x - 1, y - 1);</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;                <span class="keywordtype">bool</span> colorUR = bb_getBit(modules, x, y - 1);</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;                <span class="keywordtype">bool</span> colorL = bb_getBit(modules, x - 1, y);</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;                <span class="keywordflow">if</span> (color == colorUL &amp;&amp; color == colorUR &amp;&amp; color == colorL) {</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;                    result += <a class="code" href="../../d9/d0e/lgfx__qrcode_8c.html#a519b1f43f3570c5b453d00be72024cd1">PENALTY_N2</a>;</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;                }</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;            }</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160; </div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;            <span class="comment">// Finder-like pattern in rows and columns</span></div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;            bitsRow = ((bitsRow &lt;&lt; 1) &amp; 0x7FF) | color;</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;            bitsCol = ((bitsCol &lt;&lt; 1) &amp; 0x7FF) | bb_getBit(modules, y, x);</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160; </div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;            <span class="comment">// Needs 11 bits accumulated</span></div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;            <span class="keywordflow">if</span> (x &gt;= 10) {</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;                <span class="keywordflow">if</span> (bitsRow == 0x05D || bitsRow == 0x5D0) {</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;                    result += <a class="code" href="../../d9/d0e/lgfx__qrcode_8c.html#a0dc343ed4ac58dac0756fa31d88d40b9">PENALTY_N3</a>;</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;                }</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;                <span class="keywordflow">if</span> (bitsCol == 0x05D || bitsCol == 0x5D0) {</div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;                    result += <a class="code" href="../../d9/d0e/lgfx__qrcode_8c.html#a0dc343ed4ac58dac0756fa31d88d40b9">PENALTY_N3</a>;</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;                }</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;            }</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160; </div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;            <span class="comment">// Balance of black and white modules</span></div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;            <span class="keywordflow">if</span> (color) { black++; }</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;        }</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;    }</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160; </div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;    <span class="comment">// Find smallest k such that (45-5k)% &lt;= dark/total &lt;= (55+5k)%</span></div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;    uint_fast16_t total = size * size;</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;    <span class="keywordflow">for</span> (uint_fast16_t k = 0; black * 20 &lt; (9 - k) * total || black * 20 &gt; (11 + k) * total; k++) {</div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;        result += <a class="code" href="../../d9/d0e/lgfx__qrcode_8c.html#a376d6e3e4466769cdc71fee01c260774">PENALTY_N4</a>;</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;    }</div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160; </div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;    <span class="keywordflow">return</span> result;</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;}</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160; </div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160; </div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;<span class="comment">//#pragma mark - Reed-Solomon Generator</span></div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160; </div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;<span class="keyword">static</span> uint8_t rs_multiply(uint_fast8_t x, uint_fast8_t y) {</div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;    <span class="comment">// Russian peasant multiplication</span></div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;    <span class="comment">// See: https://en.wikipedia.org/wiki/Ancient_Egyptian_multiplication</span></div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;    uint16_t z = 0;</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;    <span class="keywordflow">for</span> (int_fast8_t i = 7; i &gt;= 0; i--) {</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;        z = (z &lt;&lt; 1) ^ ((z &gt;&gt; 7) * 0x11D);</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;        z ^= ((y &gt;&gt; i) &amp; 1) * x;</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;    }</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;    <span class="keywordflow">return</span> z;</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;}</div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160; </div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> rs_init(uint8_t degree, uint8_t *coeff) {</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;    memset(coeff, 0, degree);</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;    coeff[degree - 1] = 1;</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160; </div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;    <span class="comment">// Compute the product polynomial (x - r^0) * (x - r^1) * (x - r^2) * ... * (x - r^{degree-1}),</span></div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;    <span class="comment">// drop the highest term, and store the rest of the coefficients in order of descending powers.</span></div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;    <span class="comment">// Note that r = 0x02, which is a generator element of this field GF(2^8/0x11D).</span></div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;    uint16_t root = 1;</div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;    <span class="keywordflow">for</span> (uint_fast8_t i = 0; i &lt; degree; i++) {</div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;        <span class="comment">// Multiply the current product by (x - r^i)</span></div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;        <span class="keywordflow">for</span> (uint_fast8_t j = 0; j &lt; degree; j++) {</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;            coeff[j] = rs_multiply(coeff[j], root);</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;            <span class="keywordflow">if</span> (j + 1 &lt; degree) {</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;                coeff[j] ^= coeff[j + 1];</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;            }</div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;        }</div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;        root = (root &lt;&lt; 1) ^ ((root &gt;&gt; 7) * 0x11D);  <span class="comment">// Multiply by 0x02 mod GF(2^8/0x11D)</span></div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;    }</div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;}</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160; </div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> rs_getRemainder(uint8_t degree, uint8_t *coeff, uint8_t *<a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a>, uint8_t length, uint8_t *result, uint8_t stride) {</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;    <span class="comment">// Compute the remainder by performing polynomial division</span></div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160; </div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;    <span class="comment">//for (uint8_t i = 0; i &lt; degree; i++) { result[] = 0; }</span></div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;    <span class="comment">//memset(result, 0, degree);</span></div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160; </div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;    <span class="keywordflow">for</span> (uint_fast8_t i = 0; i &lt; length; i++) {</div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;        uint8_t factor = <a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a>[i] ^ result[0];</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;        <span class="keywordflow">for</span> (uint_fast8_t j = 1; j &lt; degree; j++) {</div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;            result[(j - 1) * stride] = result[j * stride];</div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;        }</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;        result[(degree - 1) * stride] = 0;</div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160; </div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;        <span class="keywordflow">for</span> (uint_fast8_t j = 0; j &lt; degree; j++) {</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;            result[j * stride] ^= rs_multiply(coeff[j], factor);</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;        }</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;    }</div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;}</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160; </div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160; </div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160; </div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;<span class="comment">//#pragma mark - QrCode</span></div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160; </div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;<span class="keyword">static</span> int8_t encodeDataCodewords(<a class="code" href="../../dc/d5c/structBitBucket.html">BitBucket</a> *dataCodewords, <span class="keyword">const</span> uint8_t *<a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a53eab509ea9728ec7f963272498f17e1">text</a>, uint16_t length, uint8_t version) {</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;    int8_t mode = <a class="code" href="../../d7/db8/lgfx__qrcode_8h.html#ab7e0ff654e7e14a1df60539ed21bfc48">MODE_BYTE</a>;</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160; </div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;    <span class="keywordflow">if</span> (isNumeric((<span class="keywordtype">char</span>*)<a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a53eab509ea9728ec7f963272498f17e1">text</a>, length)) {</div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;        mode = <a class="code" href="../../d7/db8/lgfx__qrcode_8h.html#acddad8d2faead956b9997a44b06cee93">MODE_NUMERIC</a>;</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;        bb_appendBits(dataCodewords, 1 &lt;&lt; <a class="code" href="../../d7/db8/lgfx__qrcode_8h.html#acddad8d2faead956b9997a44b06cee93">MODE_NUMERIC</a>, 4);</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;        bb_appendBits(dataCodewords, length, getModeBits(version, <a class="code" href="../../d7/db8/lgfx__qrcode_8h.html#acddad8d2faead956b9997a44b06cee93">MODE_NUMERIC</a>));</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160; </div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;        uint16_t accumData = 0;</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;        uint8_t accumCount = 0;</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;        <span class="keywordflow">for</span> (uint16_t i = 0; i &lt; length; i++) {</div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;            accumData = accumData * 10 + ((char)(<a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a53eab509ea9728ec7f963272498f17e1">text</a>[i]) - <span class="charliteral">&#39;0&#39;</span>);</div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;            accumCount++;</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;            <span class="keywordflow">if</span> (accumCount == 3) {</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;                <span class="keywordflow">if</span> (!bb_appendBits(dataCodewords, accumData, 10)) <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;                accumData = 0;</div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;                accumCount = 0;</div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;            }</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;        }</div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160; </div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;        <span class="comment">// 1 or 2 digits remaining</span></div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;        <span class="keywordflow">if</span> (accumCount &gt; 0) {</div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;            bb_appendBits(dataCodewords, accumData, accumCount * 3 + 1);</div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;        }</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160; </div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isAlphanumeric((<span class="keywordtype">char</span>*)<a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a53eab509ea9728ec7f963272498f17e1">text</a>, length)) {</div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;        mode = <a class="code" href="../../d7/db8/lgfx__qrcode_8h.html#a7fd315bc5cbef29f774d971a53bbc6b0">MODE_ALPHANUMERIC</a>;</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;        bb_appendBits(dataCodewords, 1 &lt;&lt; <a class="code" href="../../d7/db8/lgfx__qrcode_8h.html#a7fd315bc5cbef29f774d971a53bbc6b0">MODE_ALPHANUMERIC</a>, 4);</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;        bb_appendBits(dataCodewords, length, getModeBits(version, <a class="code" href="../../d7/db8/lgfx__qrcode_8h.html#a7fd315bc5cbef29f774d971a53bbc6b0">MODE_ALPHANUMERIC</a>));</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160; </div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;        uint16_t accumData = 0;</div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;        uint8_t accumCount = 0;</div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;        <span class="keywordflow">for</span> (uint16_t i = 0; i  &lt; length; i++) {</div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;            accumData = accumData * 45 + getAlphanumeric((<span class="keywordtype">char</span>)(<a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a53eab509ea9728ec7f963272498f17e1">text</a>[i]));</div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;            accumCount++;</div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;            <span class="keywordflow">if</span> (accumCount == 2) {</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;                <span class="keywordflow">if</span> (!bb_appendBits(dataCodewords, accumData, 11)) <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;                accumData = 0;</div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;                accumCount = 0;</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;            }</div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;        }</div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160; </div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;        <span class="comment">// 1 character remaining</span></div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;        <span class="keywordflow">if</span> (accumCount &gt; 0) {</div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;            bb_appendBits(dataCodewords, accumData, 6);</div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;        }</div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160; </div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;        bb_appendBits(dataCodewords, 1 &lt;&lt; <a class="code" href="../../d7/db8/lgfx__qrcode_8h.html#ab7e0ff654e7e14a1df60539ed21bfc48">MODE_BYTE</a>, 4);</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;        bb_appendBits(dataCodewords, length, getModeBits(version, <a class="code" href="../../d7/db8/lgfx__qrcode_8h.html#ab7e0ff654e7e14a1df60539ed21bfc48">MODE_BYTE</a>));</div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;        <span class="keywordflow">for</span> (uint16_t i = 0; i &lt; length; i++) {</div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;            <span class="keywordflow">if</span> (!bb_appendBits(dataCodewords, (<span class="keywordtype">char</span>)(<a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a53eab509ea9728ec7f963272498f17e1">text</a>[i]), 8)) <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;        }</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;    }</div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160; </div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;    <span class="comment">//bb_setBits(dataCodewords, length, 4, getModeBits(version, mode));</span></div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160; </div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;    <span class="keywordflow">return</span> mode;</div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;}</div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160; </div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;<span class="keyword">static</span> <span class="keywordtype">bool</span> performErrorCorrection(uint8_t version, uint8_t ecc, <a class="code" href="../../dc/d5c/structBitBucket.html">BitBucket</a> *<a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a>) {</div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160; </div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;    <span class="comment">// See: http://www.thonky.com/qr-code-tutorial/structure-final-message</span></div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160; </div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;<span class="preprocessor">#if LOCK_VERSION == 0</span></div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;    uint8_t numBlocks = NUM_ERROR_CORRECTION_BLOCKS[ecc][version - 1];</div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;    uint16_t totalEcc = NUM_ERROR_CORRECTION_CODEWORDS[ecc][version - 1];</div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;    uint16_t moduleCount = NUM_RAW_DATA_MODULES[version - 1];</div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;    uint8_t numBlocks = NUM_ERROR_CORRECTION_BLOCKS[ecc];</div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;    uint16_t totalEcc = NUM_ERROR_CORRECTION_CODEWORDS[ecc];</div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;    uint16_t moduleCount = NUM_RAW_DATA_MODULES;</div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160; </div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;    uint8_t blockEccLen = totalEcc / numBlocks;</div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;    uint8_t numShortBlocks = numBlocks - moduleCount / 8 % numBlocks;</div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;    uint8_t shortBlockLen = moduleCount / 8 / numBlocks;</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160; </div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;    uint8_t shortDataBlockLen = shortBlockLen - blockEccLen;</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160; </div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;    uint8_t* result = (uint8_t*)<a class="code" href="../../d9/d0e/lgfx__qrcode_8c.html#a467fdb207fabdbb103dbc08d3f5ca58e">alloca</a>(<a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a>-&gt;capacityBytes);</div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;    memset(result, 0, <a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a>-&gt;capacityBytes);</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160; </div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;    uint8_t* coeff = (uint8_t*)<a class="code" href="../../d9/d0e/lgfx__qrcode_8c.html#a467fdb207fabdbb103dbc08d3f5ca58e">alloca</a>(blockEccLen);</div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;    rs_init(blockEccLen, coeff);</div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160; </div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;    uint16_t offset = 0;</div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;    uint8_t *dataBytes = <a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a>-&gt;data;</div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160; </div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160; </div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;    <span class="comment">// Interleave all short blocks</span></div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;    <span class="keywordflow">for</span> (uint8_t i = 0; i &lt; shortDataBlockLen; i++) {</div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;        uint16_t index = i;</div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;        uint8_t stride = shortDataBlockLen;</div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;        <span class="keywordflow">for</span> (uint_fast8_t blockNum = 0; blockNum &lt; numBlocks; blockNum++) {</div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;<span class="keywordflow">if</span> (offset == <a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a>-&gt;capacityBytes) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;            result[offset++] = dataBytes[index];</div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160; </div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;<span class="preprocessor">#if LOCK_VERSION == 0 || LOCK_VERSION &gt;= 5</span></div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;            <span class="keywordflow">if</span> (blockNum == numShortBlocks) { stride++; }</div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;            index += stride;</div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;        }</div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;    }</div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160; </div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;    <span class="comment">// Version less than 5 only have short blocks</span></div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;<span class="preprocessor">#if LOCK_VERSION == 0 || LOCK_VERSION &gt;= 5</span></div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;    {</div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;        <span class="comment">// Interleave long blocks</span></div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;        uint16_t index = shortDataBlockLen * (numShortBlocks + 1);</div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;        uint8_t stride = shortDataBlockLen;</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;        <span class="keywordflow">for</span> (uint8_t blockNum = 0; blockNum &lt; numBlocks - numShortBlocks; blockNum++) {</div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;<span class="keywordflow">if</span> (offset == <a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a>-&gt;capacityBytes) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;            result[offset++] = dataBytes[index];</div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160; </div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;            <span class="keywordflow">if</span> (blockNum == 0) { stride++; }</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;            index += stride;</div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;        }</div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;    }</div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160; </div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;    <span class="comment">// Add all ecc blocks, interleaved</span></div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;    uint8_t blockSize = shortDataBlockLen;</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;    <span class="keywordflow">for</span> (uint_fast8_t blockNum = 0; blockNum &lt; numBlocks; blockNum++) {</div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160; </div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;<span class="preprocessor">#if LOCK_VERSION == 0 || LOCK_VERSION &gt;= 5</span></div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;        <span class="keywordflow">if</span> (blockNum == numShortBlocks) { blockSize++; }</div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;<span class="keywordflow">if</span> (offset + blockNum &gt;= <a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a>-&gt;capacityBytes) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;        rs_getRemainder(blockEccLen, coeff, dataBytes, blockSize, &amp;result[offset + blockNum], numBlocks);</div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;        dataBytes += blockSize;</div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;    }</div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160; </div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;    memcpy(<a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a>-&gt;data, result, <a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a>-&gt;capacityBytes);</div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;    <a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a>-&gt;bitOffsetOrWidth = moduleCount;</div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;<span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;}</div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160; </div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;<span class="comment">// We store the Format bits tightly packed into a single byte (each of the 4 modes is 2 bits)</span></div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;<span class="comment">// The format bits can be determined by ECC_FORMAT_BITS &gt;&gt; (2 * ecc)</span></div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> uint8_t ECC_FORMAT_BITS = (0x02 &lt;&lt; 6) | (0x03 &lt;&lt; 4) | (0x00 &lt;&lt; 2) | (0x01 &lt;&lt; 0);</div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160; </div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160; </div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;<span class="comment">//#pragma mark - Public QRCode functions</span></div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160; </div>
<div class="line"><a name="l00793"></a><span class="lineno"><a class="line" href="../../d7/db8/lgfx__qrcode_8h.html#a290b337784f01df701c0f1c2e72a16ea">  793</a></span>&#160;uint16_t <a class="code" href="../../d9/d0e/lgfx__qrcode_8c.html#a290b337784f01df701c0f1c2e72a16ea">lgfx_qrcode_getBufferSize</a>(uint8_t version) {</div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;    <span class="keywordflow">return</span> bb_getGridSizeBytes(4 * version + 17);</div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;}</div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160; </div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;<span class="comment">// @TODO: Return error if data is too big.</span></div>
<div class="line"><a name="l00798"></a><span class="lineno"><a class="line" href="../../d7/db8/lgfx__qrcode_8h.html#ae44358ef2c709658e367d14594cf6660">  798</a></span>&#160;int8_t <a class="code" href="../../d9/d0e/lgfx__qrcode_8c.html#ae44358ef2c709658e367d14594cf6660">lgfx_qrcode_initBytes</a>(<a class="code" href="../../d2/d17/structQRCode.html">QRCode</a> *qrcode, uint8_t *modules, uint8_t version, uint8_t ecc, uint8_t *<a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a>, uint16_t length) {</div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;    uint8_t size = version * 4 + 17;</div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;    qrcode-&gt;<a class="code" href="../../d2/d17/structQRCode.html#a8edcebbdec57acb1317d50f9a4f5901d">version</a> = version;</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;    qrcode-&gt;<a class="code" href="../../d2/d17/structQRCode.html#abfdac5888f558296a8e69edf754e4762">size</a> = size;</div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;    qrcode-&gt;<a class="code" href="../../d2/d17/structQRCode.html#a962c75a5a2a5e369cded41c73dc75291">ecc</a> = ecc;</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;    qrcode-&gt;<a class="code" href="../../d2/d17/structQRCode.html#a81f6807686d8400c405bc413e837d52b">modules</a> = modules;</div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160; </div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;    uint8_t eccFormatBits = (ECC_FORMAT_BITS &gt;&gt; (2 * ecc)) &amp; 0x03;</div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160; </div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;<span class="preprocessor">#if LOCK_VERSION == 0</span></div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;    uint16_t moduleCount = NUM_RAW_DATA_MODULES[version - 1];</div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;    uint16_t dataCapacity = (moduleCount &gt;&gt; 3) - NUM_ERROR_CORRECTION_CODEWORDS[eccFormatBits][version - 1];</div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;    version = <a class="code" href="../../d7/db8/lgfx__qrcode_8h.html#a42e94ea12f7851b1a6cff265473e6ee0">LOCK_VERSION</a>;</div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;    uint16_t moduleCount = NUM_RAW_DATA_MODULES;</div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;    uint16_t dataCapacity = (moduleCount &gt;&gt; 3) - NUM_ERROR_CORRECTION_CODEWORDS[eccFormatBits];</div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160; </div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../dc/d5c/structBitBucket.html">BitBucket</a> codewords;</div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;    int32_t codewordLen = bb_getBufferSizeBytes(moduleCount);</div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;    uint8_t* codewordBytes = (uint8_t*)<a class="code" href="../../d9/d0e/lgfx__qrcode_8c.html#a467fdb207fabdbb103dbc08d3f5ca58e">alloca</a>(codewordLen);</div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;    bb_initBuffer(&amp;codewords, codewordBytes, codewordLen);</div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160; </div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;    <span class="comment">// Place the data code words into the buffer</span></div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;    int8_t mode = encodeDataCodewords(&amp;codewords, <a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a>, length, version);</div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160; </div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;    <span class="keywordflow">if</span> (mode &lt; 0) { <span class="keywordflow">return</span> -1; }</div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;    qrcode-&gt;<a class="code" href="../../d2/d17/structQRCode.html#adbc19b7b3d1e33e6819e659ebb5b9eab">mode</a> = mode;</div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160; </div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;    <span class="comment">// Add terminator and pad up to a byte if applicable</span></div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;    int32_t padding = (dataCapacity * 8) - codewords.<a class="code" href="../../dc/d5c/structBitBucket.html#aa82a95c2871e9cd6dbdf51dc0e3e87c7">bitOffsetOrWidth</a>;</div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;    if (padding &lt; 0) <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;    <span class="keywordflow">if</span> (padding &gt; 4) { padding = 4; }</div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;    bb_appendBits(&amp;codewords, 0, padding);</div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;    bb_appendBits(&amp;codewords, 0, (8 - (codewords.<a class="code" href="../../dc/d5c/structBitBucket.html#aa82a95c2871e9cd6dbdf51dc0e3e87c7">bitOffsetOrWidth</a> &amp; 7)) &amp; 7);</div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160; </div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;    <span class="comment">// Pad with alternate bytes until data capacity is reached</span></div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;    <span class="keywordflow">for</span> (uint8_t padByte = 0xEC; codewords.<a class="code" href="../../dc/d5c/structBitBucket.html#aa82a95c2871e9cd6dbdf51dc0e3e87c7">bitOffsetOrWidth</a> &lt; (dataCapacity * 8); padByte ^= 0xEC ^ 0x11) {</div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;        bb_appendBits(&amp;codewords, padByte, 8);</div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;    }</div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160; </div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;    <a class="code" href="../../dc/d5c/structBitBucket.html">BitBucket</a> modulesGrid;</div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;    bb_initGrid(&amp;modulesGrid, modules, size);</div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160; </div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;    <a class="code" href="../../dc/d5c/structBitBucket.html">BitBucket</a> isFunctionGrid;</div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;    uint8_t* isFunctionGridBytes = (uint8_t*)<a class="code" href="../../d9/d0e/lgfx__qrcode_8c.html#a467fdb207fabdbb103dbc08d3f5ca58e">alloca</a>(bb_getGridSizeBytes(size));</div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;    bb_initGrid(&amp;isFunctionGrid, isFunctionGridBytes, size);</div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160; </div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;    <span class="comment">// Draw function patterns, draw all codewords, do masking</span></div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;    drawFunctionPatterns(&amp;modulesGrid, &amp;isFunctionGrid, version, eccFormatBits);</div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;    <span class="keywordflow">if</span> (!performErrorCorrection(version, eccFormatBits, &amp;codewords)) <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;    drawCodewords(&amp;modulesGrid, &amp;isFunctionGrid, &amp;codewords);</div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160; </div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;    <span class="comment">// Find the best (lowest penalty) mask</span></div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;    uint8_t mask = 0;</div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;    uint32_t minPenalty = ~0u;</div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;    <span class="keywordflow">for</span> (uint_fast8_t i = 0; i &lt; 8; i++) {</div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;        drawFormatBits(&amp;modulesGrid, &amp;isFunctionGrid, eccFormatBits, i);</div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;        applyMask(&amp;modulesGrid, &amp;isFunctionGrid, i);</div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;        uint32_t penalty = getPenaltyScore(&amp;modulesGrid);</div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;        <span class="keywordflow">if</span> (penalty &lt; minPenalty) {</div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;            mask = i;</div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;            minPenalty = penalty;</div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;        }</div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;        applyMask(&amp;modulesGrid, &amp;isFunctionGrid, i);  <span class="comment">// Undoes the mask due to XOR</span></div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;    }</div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160; </div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;    qrcode-&gt;<a class="code" href="../../d2/d17/structQRCode.html#a5bc7d6a5f463fc7ccf68eba3c4909033">mask</a> = mask;</div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160; </div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;    <span class="comment">// Overwrite old format bits</span></div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;    drawFormatBits(&amp;modulesGrid, &amp;isFunctionGrid, eccFormatBits, mask);</div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160; </div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;    <span class="comment">// Apply the final choice of mask</span></div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;    applyMask(&amp;modulesGrid, &amp;isFunctionGrid, mask);</div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160; </div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;}</div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160; </div>
<div class="line"><a name="l00876"></a><span class="lineno"><a class="line" href="../../d7/db8/lgfx__qrcode_8h.html#a7bed2f06f6ccb797c29007092f56ec1c">  876</a></span>&#160;int8_t <a class="code" href="../../d9/d0e/lgfx__qrcode_8c.html#a7bed2f06f6ccb797c29007092f56ec1c">lgfx_qrcode_initText</a>(<a class="code" href="../../d2/d17/structQRCode.html">QRCode</a> *qrcode, uint8_t *modules, uint8_t version, uint8_t ecc, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a>) {</div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../d9/d0e/lgfx__qrcode_8c.html#ae44358ef2c709658e367d14594cf6660">lgfx_qrcode_initBytes</a>(qrcode, modules, version, ecc, (uint8_t*)<a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a>, strlen(<a class="code" href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a>));</div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;}</div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160; </div>
<div class="line"><a name="l00880"></a><span class="lineno"><a class="line" href="../../d7/db8/lgfx__qrcode_8h.html#a50dbd1c8374f18d517d9ce7d8fd1ac1f">  880</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="../../d9/d0e/lgfx__qrcode_8c.html#a50dbd1c8374f18d517d9ce7d8fd1ac1f">lgfx_qrcode_getModule</a>(<a class="code" href="../../d2/d17/structQRCode.html">QRCode</a> *qrcode, uint_fast8_t x, uint_fast8_t y) {</div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;    <span class="keywordflow">if</span> (x &gt;= qrcode-&gt;<a class="code" href="../../d2/d17/structQRCode.html#abfdac5888f558296a8e69edf754e4762">size</a> || y &gt;= qrcode-&gt;<a class="code" href="../../d2/d17/structQRCode.html#abfdac5888f558296a8e69edf754e4762">size</a>) {</div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;    }</div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160; </div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;    uint32_t offset = y * qrcode-&gt;<a class="code" href="../../d2/d17/structQRCode.html#abfdac5888f558296a8e69edf754e4762">size</a> + x;</div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;    <span class="keywordflow">return</span> qrcode-&gt;<a class="code" href="../../d2/d17/structQRCode.html#a81f6807686d8400c405bc413e837d52b">modules</a>[offset &gt;&gt; 3] &amp; (1 &lt;&lt; (7 - (offset &amp; 0x07)));</div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;}</div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160; </div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;<span class="comment">uint8_t lgfx_qrcode_getHexLength(QRCode *qrcode) {</span></div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;<span class="comment">    return ((qrcode-&gt;size * qrcode-&gt;size) + 7) / 4;</span></div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;<span class="comment">}</span></div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;<span class="comment">void lgfx_qrcode_getHex(QRCode *qrcode, char *result) {</span></div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;<span class="comment">}</span></div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;<span class="comment">*/</span></div>
</div><!-- fragment --></div><!-- contents -->
<div class="ttc" id="astructQRCode_html_a962c75a5a2a5e369cded41c73dc75291"><div class="ttname"><a href="../../d2/d17/structQRCode.html#a962c75a5a2a5e369cded41c73dc75291">QRCode::ecc</a></div><div class="ttdeci">uint8_t ecc</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/db8/lgfx__qrcode_8h_source.html#l00073">lgfx_qrcode.h:73</a></div></div>
<div class="ttc" id="astructBitBucket_html"><div class="ttname"><a href="../../dc/d5c/structBitBucket.html">BitBucket</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d0e/lgfx__qrcode_8c_source.html#l00184">lgfx_qrcode.c:184</a></div></div>
<div class="ttc" id="aIPA__Font__License__Agreement__v1_80_8txt_html_a15e1d6a55646d0e8206765c2b98744fe"><div class="ttname"><a href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a15e1d6a55646d0e8206765c2b98744fe">data</a></div><div class="ttdeci"> reproduction or distribution of the Licensed or any exercise of rights under this Agreement by a or used to render or display fonts Licensed Program shall mean a Digital Font Program licensed by the Licensor under this Agreement Derived Program shall mean a Digital Font Program created as a result of a replacement or any other adaptation to or of a part or all of the Licensed and includes a case where a Digital Font Program newly created by retrieving font information from a part or all of the Licensed Program or Embedded Fonts from a Digital Document File with or without modification of the retrieved font information Digital Content shall mean products provided to end users in the form of digital data</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt_source.html#l00075">IPA_Font_License_Agreement_v1.0.txt:75</a></div></div>
<div class="ttc" id="algfx__qrcode_8c_html_a7bed2f06f6ccb797c29007092f56ec1c"><div class="ttname"><a href="../../d9/d0e/lgfx__qrcode_8c.html#a7bed2f06f6ccb797c29007092f56ec1c">lgfx_qrcode_initText</a></div><div class="ttdeci">int8_t lgfx_qrcode_initText(QRCode *qrcode, uint8_t *modules, uint8_t version, uint8_t ecc, const char *data)</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d0e/lgfx__qrcode_8c_source.html#l00876">lgfx_qrcode.c:876</a></div></div>
<div class="ttc" id="astructQRCode_html_a81f6807686d8400c405bc413e837d52b"><div class="ttname"><a href="../../d2/d17/structQRCode.html#a81f6807686d8400c405bc413e837d52b">QRCode::modules</a></div><div class="ttdeci">uint8_t * modules</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/db8/lgfx__qrcode_8h_source.html#l00076">lgfx_qrcode.h:76</a></div></div>
<div class="ttc" id="algfx__qrcode_8h_html_a7fd315bc5cbef29f774d971a53bbc6b0"><div class="ttname"><a href="../../d7/db8/lgfx__qrcode_8h.html#a7fd315bc5cbef29f774d971a53bbc6b0">MODE_ALPHANUMERIC</a></div><div class="ttdeci">#define MODE_ALPHANUMERIC</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/db8/lgfx__qrcode_8h_source.html#l00052">lgfx_qrcode.h:52</a></div></div>
<div class="ttc" id="algfx__qrcode_8c_html_a7b8f587ba0383fce5bb85edeb556e798"><div class="ttname"><a href="../../d9/d0e/lgfx__qrcode_8c.html#a7b8f587ba0383fce5bb85edeb556e798">PENALTY_N1</a></div><div class="ttdeci">#define PENALTY_N1</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d0e/lgfx__qrcode_8c_source.html#l00494">lgfx_qrcode.c:494</a></div></div>
<div class="ttc" id="algfx__qrcode_8c_html_a50dbd1c8374f18d517d9ce7d8fd1ac1f"><div class="ttname"><a href="../../d9/d0e/lgfx__qrcode_8c.html#a50dbd1c8374f18d517d9ce7d8fd1ac1f">lgfx_qrcode_getModule</a></div><div class="ttdeci">bool lgfx_qrcode_getModule(QRCode *qrcode, uint_fast8_t x, uint_fast8_t y)</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d0e/lgfx__qrcode_8c_source.html#l00880">lgfx_qrcode.c:880</a></div></div>
<div class="ttc" id="astructQRCode_html_abfdac5888f558296a8e69edf754e4762"><div class="ttname"><a href="../../d2/d17/structQRCode.html#abfdac5888f558296a8e69edf754e4762">QRCode::size</a></div><div class="ttdeci">uint8_t size</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/db8/lgfx__qrcode_8h_source.html#l00072">lgfx_qrcode.h:72</a></div></div>
<div class="ttc" id="astructQRCode_html_a5bc7d6a5f463fc7ccf68eba3c4909033"><div class="ttname"><a href="../../d2/d17/structQRCode.html#a5bc7d6a5f463fc7ccf68eba3c4909033">QRCode::mask</a></div><div class="ttdeci">uint8_t mask</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/db8/lgfx__qrcode_8h_source.html#l00075">lgfx_qrcode.h:75</a></div></div>
<div class="ttc" id="astructBitBucket_html_ad7d556811266f5dfc395fbf25bd75206"><div class="ttname"><a href="../../dc/d5c/structBitBucket.html#ad7d556811266f5dfc395fbf25bd75206">BitBucket::data</a></div><div class="ttdeci">uint8_t * data</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d0e/lgfx__qrcode_8c_source.html#l00187">lgfx_qrcode.c:187</a></div></div>
<div class="ttc" id="algfx__qrcode_8h_html_ab7e0ff654e7e14a1df60539ed21bfc48"><div class="ttname"><a href="../../d7/db8/lgfx__qrcode_8h.html#ab7e0ff654e7e14a1df60539ed21bfc48">MODE_BYTE</a></div><div class="ttdeci">#define MODE_BYTE</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/db8/lgfx__qrcode_8h_source.html#l00053">lgfx_qrcode.h:53</a></div></div>
<div class="ttc" id="astructQRCode_html_a8edcebbdec57acb1317d50f9a4f5901d"><div class="ttname"><a href="../../d2/d17/structQRCode.html#a8edcebbdec57acb1317d50f9a4f5901d">QRCode::version</a></div><div class="ttdeci">uint8_t version</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/db8/lgfx__qrcode_8h_source.html#l00071">lgfx_qrcode.h:71</a></div></div>
<div class="ttc" id="algfx__qrcode_8h_html_acddad8d2faead956b9997a44b06cee93"><div class="ttname"><a href="../../d7/db8/lgfx__qrcode_8h.html#acddad8d2faead956b9997a44b06cee93">MODE_NUMERIC</a></div><div class="ttdeci">#define MODE_NUMERIC</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/db8/lgfx__qrcode_8h_source.html#l00051">lgfx_qrcode.h:51</a></div></div>
<div class="ttc" id="algfx__qrcode_8c_html_a0dc343ed4ac58dac0756fa31d88d40b9"><div class="ttname"><a href="../../d9/d0e/lgfx__qrcode_8c.html#a0dc343ed4ac58dac0756fa31d88d40b9">PENALTY_N3</a></div><div class="ttdeci">#define PENALTY_N3</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d0e/lgfx__qrcode_8c_source.html#l00496">lgfx_qrcode.c:496</a></div></div>
<div class="ttc" id="algfx__qrcode_8c_html_a376d6e3e4466769cdc71fee01c260774"><div class="ttname"><a href="../../d9/d0e/lgfx__qrcode_8c.html#a376d6e3e4466769cdc71fee01c260774">PENALTY_N4</a></div><div class="ttdeci">#define PENALTY_N4</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d0e/lgfx__qrcode_8c_source.html#l00497">lgfx_qrcode.c:497</a></div></div>
<div class="ttc" id="algfx__qrcode_8c_html_ae44358ef2c709658e367d14594cf6660"><div class="ttname"><a href="../../d9/d0e/lgfx__qrcode_8c.html#ae44358ef2c709658e367d14594cf6660">lgfx_qrcode_initBytes</a></div><div class="ttdeci">int8_t lgfx_qrcode_initBytes(QRCode *qrcode, uint8_t *modules, uint8_t version, uint8_t ecc, uint8_t *data, uint16_t length)</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d0e/lgfx__qrcode_8c_source.html#l00798">lgfx_qrcode.c:798</a></div></div>
<div class="ttc" id="aIPA__Font__License__Agreement__v1_80_8txt_html_a53eab509ea9728ec7f963272498f17e1"><div class="ttname"><a href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt.html#a53eab509ea9728ec7f963272498f17e1">text</a></div><div class="ttdeci"> reproduction or distribution of the Licensed or any exercise of rights under this Agreement by a or used to render or display fonts Licensed Program shall mean a Digital Font Program licensed by the Licensor under this Agreement Derived Program shall mean a Digital Font Program created as a result of a replacement or any other adaptation to or of a part or all of the Licensed and includes a case where a Digital Font Program newly created by retrieving font information from a part or all of the Licensed Program or Embedded Fonts from a Digital Document File with or without modification of the retrieved font information Digital Content shall mean products provided to end users in the form of digital including video motion and or still TV programs or other broadcasting content and products consisting of character text</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d23/IPA__Font__License__Agreement__v1_80_8txt_source.html#l00075">IPA_Font_License_Agreement_v1.0.txt:75</a></div></div>
<div class="ttc" id="algfx__qrcode_8c_html_a290b337784f01df701c0f1c2e72a16ea"><div class="ttname"><a href="../../d9/d0e/lgfx__qrcode_8c.html#a290b337784f01df701c0f1c2e72a16ea">lgfx_qrcode_getBufferSize</a></div><div class="ttdeci">uint16_t lgfx_qrcode_getBufferSize(uint8_t version)</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d0e/lgfx__qrcode_8c_source.html#l00793">lgfx_qrcode.c:793</a></div></div>
<div class="ttc" id="algfx__qrcode_8h_html"><div class="ttname"><a href="../../d7/db8/lgfx__qrcode_8h.html">lgfx_qrcode.h</a></div></div>
<div class="ttc" id="algfx__qrcode_8c_html_a467fdb207fabdbb103dbc08d3f5ca58e"><div class="ttname"><a href="../../d9/d0e/lgfx__qrcode_8c.html#a467fdb207fabdbb103dbc08d3f5ca58e">alloca</a></div><div class="ttdeci">#define alloca</div><div class="ttdoc">The MIT License (MIT)</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d0e/lgfx__qrcode_8c_source.html#l00047">lgfx_qrcode.c:47</a></div></div>
<div class="ttc" id="astructBitBucket_html_aa82a95c2871e9cd6dbdf51dc0e3e87c7"><div class="ttname"><a href="../../dc/d5c/structBitBucket.html#aa82a95c2871e9cd6dbdf51dc0e3e87c7">BitBucket::bitOffsetOrWidth</a></div><div class="ttdeci">uint32_t bitOffsetOrWidth</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d0e/lgfx__qrcode_8c_source.html#l00185">lgfx_qrcode.c:185</a></div></div>
<div class="ttc" id="astructQRCode_html"><div class="ttname"><a href="../../d2/d17/structQRCode.html">QRCode</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d7/db8/lgfx__qrcode_8h_source.html#l00070">lgfx_qrcode.h:70</a></div></div>
<div class="ttc" id="astructBitBucket_html_a6dc7c1877c2c661d182ef086c45dd367"><div class="ttname"><a href="../../dc/d5c/structBitBucket.html#a6dc7c1877c2c661d182ef086c45dd367">BitBucket::capacityBytes</a></div><div class="ttdeci">uint16_t capacityBytes</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d0e/lgfx__qrcode_8c_source.html#l00186">lgfx_qrcode.c:186</a></div></div>
<div class="ttc" id="algfx__qrcode_8c_html_a519b1f43f3570c5b453d00be72024cd1"><div class="ttname"><a href="../../d9/d0e/lgfx__qrcode_8c.html#a519b1f43f3570c5b453d00be72024cd1">PENALTY_N2</a></div><div class="ttdeci">#define PENALTY_N2</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d0e/lgfx__qrcode_8c_source.html#l00495">lgfx_qrcode.c:495</a></div></div>
<div class="ttc" id="algfx__qrcode_8h_html_a42e94ea12f7851b1a6cff265473e6ee0"><div class="ttname"><a href="../../d7/db8/lgfx__qrcode_8h.html#a42e94ea12f7851b1a6cff265473e6ee0">LOCK_VERSION</a></div><div class="ttdeci">#define LOCK_VERSION</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/db8/lgfx__qrcode_8h_source.html#l00066">lgfx_qrcode.h:66</a></div></div>
<div class="ttc" id="astructQRCode_html_adbc19b7b3d1e33e6819e659ebb5b9eab"><div class="ttname"><a href="../../d2/d17/structQRCode.html#adbc19b7b3d1e33e6819e659ebb5b9eab">QRCode::mode</a></div><div class="ttdeci">uint8_t mode</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/db8/lgfx__qrcode_8h_source.html#l00074">lgfx_qrcode.h:74</a></div></div>
<div class="ttc" id="algfx__qrcode_8c_html_a3d6cd6f5c323535575f53fbff6b5c86f"><div class="ttname"><a href="../../d9/d0e/lgfx__qrcode_8c.html#a3d6cd6f5c323535575f53fbff6b5c86f">BitBucket</a></div><div class="ttdeci">struct BitBucket BitBucket</div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
